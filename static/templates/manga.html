<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Manga</title>
	<style>
		:root { --bg: #0e0e10; --panel: #17171a; --text: #e6e6ea; --muted: #a0a0a8; --accent: #ff3d6e; --accent-2: #5cc8ff; --border: #2a2a30; }
		body { background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial, sans-serif; margin: 0; padding: 0; }
		.container { max-width: 900px; margin: 0 auto; padding: 24px; }
		header.site { position: sticky; top: 0; z-index: 10; background: linear-gradient(180deg, rgba(23, 23, 26, 0.95), rgba(23, 23, 26, 0.85)); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border); }
		header.site .wrap { display: flex; align-items: center; justify-content: space-between; padding: 14px 24px; }
		.brand { display: flex; align-items: center; gap: 10px; font-weight: 800; }
		.brand .logo { width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); display: inline-block; }
		.brand a { color: var(--text); text-decoration: none; font-size: 18px; }

		/* Summary Panel */
		.summary-background { position: relative; border-radius: 12px; overflow: hidden; margin-bottom: 32px; border: 1px solid var(--border); }
		.summary-background::before { content: ''; position: absolute; inset: 0; background-size: cover; background-position: center; filter: blur(20px) brightness(0.5); transform: scale(1.1); }
		.summary-panel { position: relative; padding: 24px; background: linear-gradient(to bottom, rgba(14, 14, 16, 0.7), rgba(14, 14, 16, 0.9)); border-radius: 12px; }
		.manga-info { display: flex; gap: 24px; margin-bottom: 24px; overflow: hidden; }
		.cover img { width: 180px; height: 260px; border-radius: 8px; object-fit: cover; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
		.info { flex: 1; display: flex; flex-direction: column; }
		.info h1 { font-size: 32px; font-weight: 800; margin: 0 0 8px; text-transform: uppercase; }
		.info .meta-list { display: flex; flex-direction: column; gap: 8px; font-size: 14px; color: #c0c0c8; margin-top: 8px; }
		.breadcrumbs { font-size: 14px; color: var(--muted); margin-bottom: 16px; }
		.breadcrumbs a { color: var(--accent-2); text-decoration: none; }
		.breadcrumbs a:hover { text-decoration: underline; }
		.breadcrumbs span { color: var(--text); }

		.info .meta-item strong { color: var(--text); font-weight: 600; margin-right: 6px; }
		.info .meta-item a { color: var(--accent-2); text-decoration: none; }
		.info .meta-item a:hover { text-decoration: underline; }
		.genres { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
		.genre-tag { background: #22232a; color: var(--accent-2); padding: 4px 10px; border-radius: 16px; font-size: 12px; font-weight: 600; text-decoration: none; }
		#summary { font-size: 15px; line-height: 1.6; color: var(--muted); margin-top: 16px; max-height: 6.2em; overflow: hidden; position: relative; transition: max-height 0.5s ease-in-out; }
		#summary.expanded { max-height: 1000px; }
		#summary #desc { margin: 0; }
		#read-more { color: var(--accent-2); cursor: pointer; font-weight: 600; margin-top: 8px; display: inline-block; }

		/* Chapters Panel */
		.chapters-panel { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; }
		.chapters-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); }
		.chapters-header h2 { margin: 0; font-size: 20px; }
		.chapter-controls { display: flex; gap: 12px; }
		.chapter-controls input, .chapter-controls button { background: #22232a; color: var(--text); border: 1px solid #3a3a42; border-radius: 8px; padding: 8px 12px; font-size: 14px; }
		.chapter-controls input:focus { outline: none; border-color: var(--accent); }
		.chapter-controls button { cursor: pointer; font-weight: 600; }
		.chapters-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 500px; overflow-y: auto; padding: 8px; }
		/* Firefox scrollbar styling */
		.chapters-list { scrollbar-width: thin; scrollbar-color: #3a3a42 var(--panel); }
		/* Webkit (Chrome, Safari, Edge) scrollbar styling */
		.chapters-list::-webkit-scrollbar { width: 8px; }
		.chapters-list::-webkit-scrollbar-track { background: transparent; }
		.chapters-list::-webkit-scrollbar-thumb { background-color: #3a3a42; border-radius: 10px; border: 2px solid var(--panel); }
		.chapters-list::-webkit-scrollbar-thumb:hover { background-color: var(--accent); }

		.chapter-item { display: flex; align-items: baseline; padding: 12px; border-radius: 8px; transition: background-color 0.2s; color: var(--text); text-decoration: none; font-weight: 500; }
		.chapter-item:hover { background-color: rgba(255,255,255,0.05); color: var(--accent); }
		.chapter-item .chapter-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
		.chapter-item .release-date { font-size: 12px; color: var(--muted); flex-shrink: 0; margin-left: 8px; }

		@media (max-width: 600px) { 
			.manga-info { flex-direction: column; align-items: center; text-align: center; } 
			.cover img { width: 150px; height: 220px; } 
			.breadcrumbs { text-align: center; }
			.info h1 { font-size: 24px; } 
			.info .meta-list { align-items: center; }
			.genres { justify-content: center; }
			.chapters-header { flex-direction: column; gap: 12px; }
			.chapters-list { grid-template-columns: 1fr; }
		}
	</style>
</head>

<body>
	{% include "Components/header.html" %}

	<div class="container">
		<div class="summary-background">
			<div class="summary-panel">
			<div class="breadcrumbs"><a href="/">Home</a> &raquo; <span id="manga-breadcrumb-title"></span></div>
			<div class="manga-info">
				<div class="cover">
					<img id="coverImg" src="" alt="Cover image">
				</div>
				<div class="info">
					<h1 id="title">Loading...</h1>
					<div class="meta-list">
						<div class="meta-item"><strong>Author:</strong> <span id="author"></span></div>
						<div class="meta-item"><strong>Status:</strong> <span id="status"></span></div>
						<div class="meta-item"><strong>Rank:</strong> <span id="rank"></span></div>
						<div class="meta-item"><strong>Bookmarked:</strong> <span id="bookmarked"></span></div>
						<div class="meta-item" id="source-item" style="display: none;"><strong>Source:</strong> <a id="sourceLink" target="_blank" rel="noopener noreferrer">Visit Source</a></div>
					</div>
					<div id="genres" class="genres"></div>
				</div>
			</div>
			<div id="summary">
				<p id="desc"></p>
			</div>
			<a id="read-more">Read more</a>
		</div>
	</div>
	<div class="chapters-panel">
		<div class="chapters-header">
			<h2>Chapters</h2>
			<div class="chapter-controls">
				<input type="text" id="chapterSearch" placeholder="Filter chapters...">
				<button id="sortChaptersBtn">Sort: Newest</button>
			</div>
		</div>
		<div id="chapters" class="chapters-list"></div>
	</div>

	<script>
		const pathParts = window.location.pathname.split("/");
		const slug = pathParts[2]; // /manga/<slug>
		if (!slug) {
			document.querySelector('.container').innerHTML =
				'<p class="muted">Invalid manga URL.</p>';
		}

		const chaptersContainer = document.getElementById('chapters');
		const chapterSearch = document.getElementById('chapterSearch');
		const sortBtn = document.getElementById('sortChaptersBtn');
		const summaryDiv = document.getElementById('summary');
		const readMoreBtn = document.getElementById('read-more');

		let currentChapters = [];
		let sortAsc = false;

		function renderChapters(chapters) {
			const query = chapterSearch.value.toLowerCase();
			let filtered = chapters.filter(c => c.number.toString().includes(query) || (c.title || '').toLowerCase().includes(query));

			if (sortAsc) {
				filtered.sort((a, b) => a.number - b.number);
			} else {
				filtered.sort((a, b) => b.number - a.number);
			}

			chaptersContainer.innerHTML = filtered.map(c => `
				<a href="/manga/${slug}/chapter-${c.number}" class="chapter-item">
					<span class="chapter-title">Ch. ${c.number}${c.title ? ` | ${c.title}` : ''}</span>
					<span class="release-date">${c.release_date || ''}</span>
				</a>
		`).join('');
		}

		sortBtn.addEventListener('click', () => {
			sortAsc = !sortAsc;
			sortBtn.textContent = sortAsc ? 'Sort: Oldest' : 'Sort: Newest';
			renderChapters(currentChapters);
		});

		chapterSearch.addEventListener('input', () => renderChapters(currentChapters));

		readMoreBtn.addEventListener('click', () => {
			summaryDiv.classList.toggle('expanded');
			readMoreBtn.textContent = summaryDiv.classList.contains('expanded') ? 'Read less' : 'Read more';
		});

		fetch(`/api/manga/${slug}`)
			.then(r => r.ok ? r.json() : {})
			.then(data => {
				if (!data || !data.title) {
					document.querySelector('.container').innerHTML =
						'<p class="muted">Failed to load manga details.</p>';
					return;
				}

				document.title = data.title;
				document.getElementById('title').textContent = data.title;
				document.getElementById('manga-breadcrumb-title').textContent = data.title;
				document.getElementById('author').textContent = data.author || '';
				document.getElementById('status').textContent = data.status || 'Unknown';
				document.getElementById('rank').textContent = data.rank || 'N/A';
				document.getElementById('bookmarked').textContent = data.bookmarked || 0;
				document.getElementById('genres').innerHTML = (data.genres || []).map(g => `<a href="#" class="genre-tag">${g}</a>`).join('');
				document.getElementById('desc').textContent = data.description || '';
				document.getElementById('coverImg').src = data.thumbnail || '';
				document.getElementById('coverImg').alt = data.title;
				document.querySelector('.summary-background').style.setProperty('background-image', `url(${data.thumbnail})`);

				// After all fonts are loaded, check if the summary text is overflowing.
				// This is the most reliable way to get the correct height.
				document.fonts.ready.then(() => {
					if (summaryDiv.scrollHeight <= summaryDiv.clientHeight) {
						readMoreBtn.style.display = 'none';
					}
				});

				const sourceItem = document.getElementById('source-item');
				if (data.url) {
					document.getElementById('sourceLink').href = data.url;
					sourceItem.style.display = 'block';
				}

				currentChapters = data.chapters || [];
				renderChapters(currentChapters);
			})
			.catch(() => {
				document.querySelector('.container').innerHTML =
					'<p class="muted">Failed to load manga info.</p>';
			});
	</script>
</body>
</html>
