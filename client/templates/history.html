<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reading History - MangaReader+</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles/style.css">
    <style>
        /* Scoped admin-like styles to make public history match admin user view */
        .section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .section-header {
            background: #0f172a;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            gap: 1rem;
            justify-content: space-between;
        }
        .section-header h2 { color: #e0e6ed; margin: 0; font-size: 1.25rem; }
        .section-content { padding: 1.5rem; }
        /* Card-like grouping for each manga so groups are clearly separated */
        .manga-history-list { display: block; }
        .manga-history-item {
            background: linear-gradient(180deg, rgba(15,23,42,0.6), rgba(15,23,42,0.4));
            border: 1px solid rgba(51,65,85,0.9);
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(2,6,23,0.35);
            margin-bottom: 1rem;
            overflow: hidden;
            transition: transform 120ms ease, box-shadow 120ms ease;
        }
        .manga-history-item:hover { transform: translateY(-3px); box-shadow: 0 14px 30px rgba(2,6,23,0.45); }
        .manga-header { display:flex; align-items:center; gap:1rem; padding:1rem; }
        .manga-thumbnail { width:60px; height:80px; background:#0f172a; border-radius:4px; overflow:hidden; flex-shrink:0 }
        .manga-thumbnail img { width:100%; height:100%; object-fit:cover }
        .manga-info { flex:1 }
    .manga-title { color:#e0e6ed; font-weight:600; margin-bottom:0.25rem; font-size:1.05rem }
    .manga-meta { color:#94a3b8; font-size:0.875rem }
        .chapters-list { background:#0f172a; padding:1rem }
    .chapter-item { display:flex; justify-content:space-between; align-items:center; padding:0.6rem 1rem; border-bottom:1px dashed rgba(51,65,85,0.6); font-size:0.9rem }
        .chapter-item:last-child { border-bottom:none }

        /* Chapter link styling: remove default blue + underline and use site accent color */
        .chapter-number,
        .chapter-number:link,
        .chapter-number:visited {
            color: #60a5fa; /* soft accent */
            font-weight:500;
            min-width:60px;
            text-decoration: none;
            border-bottom: 1px dashed transparent;
            transition: color 120ms ease, border-bottom-color 120ms ease;
        }
        .chapter-number:hover,
        .chapter-number:focus {
            color: #3b82f6;
            border-bottom-color: rgba(59,130,246,0.45);
            outline: none;
        }

        /* make the entire chapter row clickable when it's an anchor */
        .manga-history-item a.chapter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 1rem;
            border-bottom: 1px dashed rgba(51,65,85,0.6);
            font-size: 0.9rem;
            color: inherit;
            text-decoration: none;
        }
        .manga-history-item a.chapter-item:last-child { border-bottom: none }
        .manga-history-item a.chapter-item:focus {
            outline: 2px solid rgba(59,130,246,0.25);
            outline-offset: 2px;
        }
        .manga-history-item a.chapter-item:hover .chapter-number { color: #3b82f6 }

        .chapter-date { color:#94a3b8; font-size:0.8rem; white-space:nowrap; margin-left:1rem }
        .manga-history-item.hidden { display:none }
        .search-container { position:relative; margin-left:auto; max-width:300px }
        .search-input { width:100%; padding:0.5rem 2.5rem 0.5rem 1rem; background:#0f172a; border:1px solid #334155; border-radius:6px; color:#e0e6ed; font-size:0.875rem }
        .search-input:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.1) }
        .search-icon { position:absolute; right:0.75rem; top:50%; transform:translateY(-50%); color:#94a3b8; pointer-events:none }
            /* Progress UI for chapter read percent */
            .chapter-progress { display:inline-flex; align-items:center; gap:0.5rem; }
            .progress-pill { background: linear-gradient(90deg,#60a5fa,#3b82f6); color: #fff; padding:2px 6px; border-radius:999px; font-size:0.78rem; font-weight:600; box-shadow: 0 1px 0 rgba(0,0,0,0.15); }
            .progress-bar { width:72px; height:8px; background:#0b1220; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,0.04); box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); }
            .progress-bar-inner { height:100%; background: linear-gradient(90deg,#7dd3fc,#3b82f6); width:0%; transition: width 260ms ease; }
            .chapter-meta-muted { color:#94a3b8; font-size:0.85rem }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-container">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                <div class="brand">
                    <div class="logo-icon"></div>
                    <a href="/" class="brand-text">MangaReader<span class="accent">+</span></a>
                </div>
            </div>
            <div class="header-right">
                {% if current_user.is_authenticated %}
                    <div class="user-menu">
                        <div class="user-info-col">
                            <span class="username">{{ current_user.username }}</span>
                            {% if current_user.is_administrator() %}
                                <a href="{{ url_for('admin_panel') }}" class="admin-btn" style="color: #dc2626; text-decoration: none; font-size: 0.9rem;">Admin</a>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
                    </div>
                {% else %}
                    <div class="auth-buttons">
                        <a href="{{ url_for('login') }}" class="btn secondary">Login</a>
                        <a href="{{ url_for('register') }}" class="btn primary">Register</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </header>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Main Sidebar -->
    <aside class="main-sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <div class="sidebar-logo"></div>
                <span class="sidebar-title">Navigation</span>
            </div>
            <button class="sidebar-close" id="sidebarClose" aria-label="Close sidebar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
        
        <div class="sidebar-content">
            <div class="sidebar-section">
                <h3 class="section-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Features
                </h3>
                <nav class="sidebar-nav">
                    <a href="/" class="nav-item">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Home</span>
                    </a>
                    <a href="/bookmarks" class="nav-item">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M19 21L12 16L5 21V5C5 4.46957 5.21071 3.96086 5.58579 3.58579C5.96086 3.21071 6.46957 3 7 3H17C17.5304 3 18.0391 3.21071 18.4142 3.58579C18.7893 3.96086 19 4.46957 19 5V21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Bookmarks</span>
                    </a>
                    <a href="/history" class="nav-item active">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <polyline points="12,6 12,12 16,14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Reading History</span>
                    </a>

                    <!-- Latest Updates link removed -->
                    <a href="/random" class="nav-item">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <polyline points="23,4 23,10 17,10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline>
                            <polyline points="1,20 1,14 7,14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline>
                            <path d="M20.49 9C19.9828 7.56678 19.1209 6.28392 17.9845 5.27304C16.8482 4.26216 15.4745 3.55814 13.9917 3.22454C12.5089 2.89094 10.9652 2.93925 9.50481 3.36518C8.04437 3.79112 6.71475 4.58165 5.64 5.66L1 10M23 14L18.36 18.34C17.2853 19.4183 15.9556 20.2089 14.4952 20.6348C13.0348 21.0607 11.4911 21.109 10.0083 20.7755C8.52547 20.4419 7.1518 19.7378 6.01547 18.727C4.87913 17.7161 4.01719 16.4332 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                        <span>Random Manga</span>
                    </a>
                </nav>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <div class="footer-info">
                <span class="footer-text">Made with ❤️ by FBAMSE</span>
                <div class="footer-version">v2.0</div>
            </div>
        </div>
    </aside>

    <div class="container">
        <div class="page-header">
            <h1>Reading History</h1>
            <p class="page-subtitle">Chapters you've recently read</p>
        </div>

        {% if not current_user.is_authenticated %}
            <div class="auth-required">
                <div class="auth-message">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <polyline points="12,6 12,12 16,14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <h3>Login Required</h3>
                    <p>Please log in to view your reading history</p>
                    <div class="auth-buttons">
                        <a href="{{ url_for('login') }}" class="btn primary">Login</a>
                        <a href="{{ url_for('register') }}" class="btn secondary">Register</a>
                    </div>
                </div>
            </div>
        {% else %}
                {% if grouped_history %}
                    <div class="section">
                        <div class="section-header">
                            <h2>Reading History ({{ grouped_history|length }} manga)</h2>
                            <div class="search-container">
                                <input type="text" id="historySearch" placeholder="Search manga..." class="search-input">
                                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                                    <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                                    <path d="M21 21L16.5 16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                        </div>

                        <div class="section-content">
                            <div class="manga-history-list">
                                {% for manga in grouped_history %}
                                    <div class="manga-history-item" data-manga-title="{{ manga.manga_title|lower }}">
                                        <div class="manga-header">
                                            <div class="manga-thumbnail">
                                                {% if manga.manga_thumbnail %}
                                                    {% if manga.manga_thumbnail.startswith('http') %}
                                                        <img src="{{ manga.manga_thumbnail }}" alt="{{ manga.manga_title }}" loading="lazy">
                                                    {% elif manga.manga_thumbnail.startswith('/') %}
                                                        <img src="{{ manga.manga_thumbnail }}" alt="{{ manga.manga_title }}" loading="lazy">
                                                    {% elif manga.manga_thumbnail.startswith('static/') %}
                                                        <img src="{{ url_for('static', filename=manga.manga_thumbnail.replace('static/', '')) }}" alt="{{ manga.manga_title }}" loading="lazy">
                                                    {% else %}
                                                        <img src="{{ url_for('static', filename='thumbnail/' ~ manga.manga_thumbnail) }}" alt="{{ manga.manga_title }}" loading="lazy">
                                                    {% endif %}
                                                {% else %}
                                                    <img src="/static/default-thumbnail.svg" alt="{{ manga.manga_title }}">
                                                {% endif %}
                                            </div>
                                            <div class="manga-info">
                                                <div class="manga-title">{{ manga.manga_title }}</div>
                                                <div class="manga-meta">
                                                    {{ manga.chapters|length }} chapters read
                                                    {% if manga.total_chapters %}
                                                        ({{ manga.chapters|length }}/{{ manga.total_chapters }})
                                                    {% endif %}
                                                    • Latest: {{ manga.latest_read.strftime('%B %d, %Y') }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="chapters-list">
                                            {% for chapter in manga.chapters|sort(attribute='number', reverse=true) %}
                                                {% set scroll_q = ('?scroll=' ~ chapter.scroll_position) if chapter.scroll_position is not none %}
                                                <a href="/manga/{{ manga.manga_slug }}/chapter-{{ chapter.number }}{{ scroll_q|default('') }}" class="chapter-item">
                                                    <span style="display:flex; align-items:center; gap:0.75rem;">
                                                        <span class="chapter-number">Ch. {{ chapter.number }}</span>
                                                        {% if chapter.scroll_percent is not none %}
                                                            <span class="chapter-meta-muted" style="color:#94a3b8; font-size:0.85rem;">({{ chapter.scroll_percent }}%)</span>
                                                        {% elif chapter.scroll_position is not none %}
                                                            <span class="chapter-meta-muted" style="color:#94a3b8; font-size:0.85rem;">({{ chapter.scroll_position }}px)</span>
                                                        {% endif %}
                                                    </span>
                                                    <span class="chapter-date">{{ chapter.read_at.strftime('%b %d, %Y at %H:%M') }}</span>
                                                </a>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% elif history %}
                    <div class="controls">
                        <button id="clearHistoryBtn" class="btn secondary">Clear All History</button>
                    </div>
                    <div class="history-list">
                        {% for item in history %}
                            <div class="history-item">
                                <div class="history-thumb">
                                    <a href="/manga/{{ item.manga_slug }}">
                                        <img src="{{ item.manga_thumbnail or '/static/default-thumbnail.svg' }}" alt="{{ item.manga_title }}">
                                    </a>
                                </div>
                                <div class="history-content">
                                    <h3 class="history-title">
                                        <a href="/manga/{{ item.manga_slug }}">{{ item.manga_title }}</a>
                                    </h3>
                                    <div class="history-chapter">
                                        <a href="/manga/{{ item.manga_slug }}/chapter-{{ item.chapter_number }}" class="chapter-link">
                                            Chapter {{ item.chapter_number }}
                                        </a>
                                    </div>
                                    <div class="history-date">
                                        Read {{ item.last_read_at.strftime('%Y-%m-%d at %H:%M') }}
                                    </div>
                                </div>
                                <div class="history-actions">
                                    <button class="history-remove" data-id="{{ item.id }}" title="Remove from history">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                            <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
            {% else %}
                <div class="empty-state">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <polyline points="12,6 12,12 16,14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <h3>No Reading History</h3>
                    <p>Start reading manga to build your history!</p>
                    <a href="/" class="btn primary">Browse Manga</a>
                </div>
            {% endif %}
        {% endif %}
    </div>

    <script>
        // Sidebar toggle functionality
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarClose = document.getElementById('sidebarClose');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebar = document.getElementById('sidebar');
        const body = document.body;
        
        sidebarToggle && sidebarToggle.addEventListener('click', () => {
            sidebar && sidebar.classList.add('active');
            sidebarOverlay && sidebarOverlay.classList.add('active');
            body.classList.add('sidebar-open');
        });
        
        const closeSidebar = () => {
            sidebar && sidebar.classList.remove('active');
            sidebarOverlay && sidebarOverlay.classList.remove('active');
            body.classList.remove('sidebar-open');
        };
        
        sidebarClose && sidebarClose.addEventListener('click', closeSidebar);
        sidebarOverlay && sidebarOverlay.addEventListener('click', closeSidebar);
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && sidebar && sidebar.classList.contains('active')) {
                closeSidebar();
            }
        });

        // Custom confirmation modal for history actions
        (function() {
            // Reuse the same styling/modal pattern as bookmarks
            const overlayId = 'historyConfirmOverlay';
            // inject modal into DOM
            const modalHtml = `
                <div class="bookmark-confirm-overlay" id="${overlayId}" aria-hidden="true">
                    <div class="bookmark-confirm-modal" role="dialog" aria-modal="true" aria-labelledby="historyConfirmTitle">
                        <h3 id="historyConfirmTitle">Confirm action</h3>
                        <p id="historyConfirmDesc">Are you sure you want to continue? This cannot be undone.</p>
                        <div class="bookmark-confirm-actions">
                            <button class="btn secondary" id="historyCancelBtn">Cancel</button>
                            <button class="btn primary" id="historyConfirmBtn">Confirm</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const overlay = document.getElementById(overlayId);
            const confirmBtn = document.getElementById('historyConfirmBtn');
            const cancelBtn = document.getElementById('historyCancelBtn');
            let activeAction = null; // { type: 'item'|'clear', id?, button? }

            function openModal(action) {
                activeAction = action;
                overlay.classList.add('active');
                overlay.setAttribute('aria-hidden', 'false');
                confirmBtn.focus();
            }
            function closeModal() {
                overlay.classList.remove('active');
                overlay.setAttribute('aria-hidden', 'true');
                activeAction = null;
            }

            // per-item delete
            document.querySelectorAll('.history-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = btn.dataset.id;
                    openModal({ type: 'item', id, button: btn });
                });
            });

            // clear all
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            clearHistoryBtn && clearHistoryBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openModal({ type: 'clear' });
            });

            cancelBtn.addEventListener('click', closeModal);
            overlay.addEventListener('click', (e) => { if (e.target === overlay) closeModal(); });

            confirmBtn.addEventListener('click', async () => {
                if (!activeAction) return closeModal();
                if (activeAction.type === 'item') {
                    const id = activeAction.id;
                    try {
                        const response = await fetch(`/api/history/${id}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });
                        if (response.ok) {
                            activeAction.button.closest('.history-item').remove();
                            if (document.querySelectorAll('.history-item').length === 0) location.reload();
                        } else alert('Failed to remove history item');
                    } catch (err) { alert('Error removing history item'); }
                } else if (activeAction.type === 'clear') {
                    try {
                        const response = await fetch('/api/history/clear', { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });
                        if (response.ok) location.reload(); else alert('Failed to clear history');
                    } catch (err) { alert('Error clearing history'); }
                }
                closeModal();
            });

            document.addEventListener('keydown', (e) => {
                if (overlay.classList.contains('active')) {
                    if (e.key === 'Escape') closeModal();
                    if (e.key === 'Enter') confirmBtn.click();
                }
            });
        })();

        // Convert stored px scrolls into estimated percent for user-friendly display
        (function() {
            const AVG_PAGE_HEIGHT = 1200; // heuristic px per page when computing percent
            const mangaCache = {}; // slug -> promise of chapters data

            function fetchChaptersForManga(slug) {
                if (mangaCache[slug]) return mangaCache[slug];
                mangaCache[slug] = fetch(`/api/manga/${encodeURIComponent(slug)}/all_chapters`).then(r => r.json()).catch(() => ({ chapters: [] }));
                return mangaCache[slug];
            }

            // find all chapter meta spans that currently display px (e.g., "(10923px)")
            const chapterMetaSpans = Array.from(document.querySelectorAll('.chapter-meta-muted'));
            chapterMetaSpans.forEach(span => {
                const txt = (span.textContent || '').trim();
                if (!txt) return;
                // quick detect px pattern
                const pxMatch = txt.match(/^(?:\()?([0-9]{1,6})px(?:\))?$/);
                if (!pxMatch) return;
                const px = parseInt(pxMatch[1], 10) || 0;

                // find nearest chapter anchor to read attributes
                const anchor = span.closest('.chapter-item');
                if (!anchor) return;
                // link href is /manga/<slug>/chapter-<num>
                const href = anchor.getAttribute('href') || '';
                const parts = href.split('/');
                // URL like ['', 'manga', 'slug', 'chapter-86?scroll=...']
                if (parts.length < 4) return;
                const slug = parts[2];
                const chapterPart = parts[3] || '';
                const chapMatch = chapterPart.match(/chapter-(\d+)/);
                if (!chapMatch) return;
                const chapNum = parseInt(chapMatch[1], 10);

                // fetch chapter list for this manga then compute percent
                fetchChaptersForManga(slug).then(data => {
                    const chapters = (data && data.chapters) || [];
                    const target = chapters.find(c => parseInt(c.number,10) === chapNum);
                    const pageCount = (target && target.pages && target.pages.length) ? target.pages.length : 0;

                    let percent = 0;
                    if (pageCount > 0) {
                        // estimate total scrollable height = pages * avg page height
                        const total = Math.max(pageCount * AVG_PAGE_HEIGHT, 1);
                        percent = Math.round((px / total) * 100);
                    } else {
                        // no page count available: fallback estimate using a large default total
                        const total = Math.max(8000, 1);
                        percent = Math.round((px / total) * 100);
                    }
                    if (percent < 0) percent = 0;
                    if (percent > 100) percent = 100;

                    // Update the UI: show percent and keep px in title as tooltip
                    span.textContent = `(${percent}%)`;
                    span.setAttribute('title', `${px}px saved`);
                }).catch(() => {
                    // leave px text as-is on error
                });
            });
        })();

        // History search: filter manga-history-item by title (debounced)
        (function() {
            const searchInput = document.getElementById('historySearch');
            if (!searchInput) return;

            const items = Array.from(document.querySelectorAll('.manga-history-item'));
            let timer = null;

            function doFilter(query) {
                const q = (query || '').trim().toLowerCase();
                if (!q) {
                    items.forEach(it => it.classList.remove('hidden'));
                    return;
                }

                items.forEach(it => {
                    const titleAttr = it.dataset.mangaTitle || '';
                    const titleElem = it.querySelector('.manga-title');
                    const titleText = titleElem ? titleElem.textContent.trim().toLowerCase() : '';
                    const combined = (titleAttr + ' ' + titleText).toLowerCase();
                    if (combined.indexOf(q) !== -1) {
                        it.classList.remove('hidden');
                    } else {
                        it.classList.add('hidden');
                    }
                });
            }

            searchInput.addEventListener('input', (e) => {
                const v = e.target.value;
                if (timer) clearTimeout(timer);
                timer = setTimeout(() => doFilter(v), 180);
            });

            // optional: support Enter to focus first visible match
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    searchInput.value = '';
                    doFilter('');
                }
            });
        })();
    </script>
</body>
</html>